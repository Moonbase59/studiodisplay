var mqtt,reconnectTimeout,reconnect,host,port,clientId,username,password,weatherTopic,indicatorTopic,radioTopic,kodiTopic,commandTopic,latitude,longitude,i18n,updateLighting,mySection="webclient",mqttSection="mqtt";config=new ConfigIniParser;var kodiPlaybackState=0,locale=Intl.DateTimeFormat().resolvedOptions().locale,timezoneLong=Intl.DateTimeFormat().resolvedOptions().timeZone;function dayPhase(t,e){for(var n=[["nightEnd","astronomical"],["nauticalDawn","nautical"],["blueHourDawn","nautical_blue"],["dawn","civil_blue"],["blueHourDawnEnd","civil"],["sunrise","horizon"],["sunriseEnd","golden"],["goldenHourEnd","daylight"],["goldenHour","golden"],["sunsetStart","horizon"],["sunset","civil"],["blueHourDusk","civil_blue"],["dusk","nautical_blue"],["blueHourDuskEnd","nautical"],["nauticalDusk","astronomical"],["night","night"]],o=["night","night"],a=0;a<n.length;a++){var r=e[n[a][0]];null!==r&&t>=r&&(o=n[a])}return o[1]}function getLighting(t){var e="rgba(0,0,0,0.75)",n="rgba(255,255,255,0.75)",o={daylight:{fullName:i18n.__("Daylight"),shortName:"daylight",backgroundColor:"#85a8c3",textColor:e},golden:{fullName:i18n.__("Golden hour"),shortName:"golden",backgroundColor:"#aa8a62",textColor:e},horizon:{fullName:i18n.__("Sunrise/Sunset"),shortName:"horizon",backgroundColor:"#912d25",textColor:n},civil:{fullName:i18n.__("Civil Twilight"),shortName:"civil",backgroundColor:"#a19e9f",textColor:e},civil_blue:{fullName:i18n.__("Civil Twilight (Blue hour)"),shortName:"civil_blue",backgroundColor:"#979598",textColor:e},nautical:{fullName:i18n.__("Nautical Twilight"),shortName:"nautical",backgroundColor:"#103980",textColor:n},nautical_blue:{fullName:i18n.__("Nautical Twilight (Blue hour)"),shortName:"nautical_blue",backgroundColor:"#103980",textColor:n},astronomical:{fullName:i18n.__("Astronomical Twilight"),shortName:"astronomical",backgroundColor:"#101e31",textColor:n},night:{fullName:i18n.__("Night"),shortName:"night",backgroundColor:"#0d121f",textColor:n},unknown:{fullName:"",shortName:"unknown",backgroundColor:"#ffffff",textColor:e}};if(void 0===t)var t=new Date;var a="unknown",r=SunCalc.getTimes(t,latitude,longitude);return o[a=dayPhase(t,r)]}function date2HHmm(t){var e={hour:"2-digit",minute:"2-digit",timeZone:timezoneLong};return t?t.toLocaleString(locale,e):""}function HHmm2date(t){var e=t.split(":");return 2===e.length?(hour=parseInt(e[0],10),minute=parseInt(e[1],10),second=0,date=new Date(null,null,null,hour,minute,second)):null}function HHmm2HHmm(t){var e=HHmm2date(t);return e?date2HHmm(e):""}function numberCheck(t){return!isNaN(t)}function unitConvert(t,e,n,o=0){function a(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}var r={mm:{to:function(t){return t/1e3},from:function(t){return 1e3*t}},cm:{to:function(t){return t/100},from:function(t){return 100*t}},m:{to:function(t){return t},from:function(t){return t}},in:{to:function(t){return t/39.37007874},from:function(t){return 39.37007874*t}},ft:{to:function(t){return t/3.280839895},from:function(t){return 3.280839895*t}}},l={K:{to:function(t){return t},from:function(t){return t}},C:{to:function(t){return t+273.15},from:function(t){return t-273.15}},F:{to:function(t){return(t+459.67)*5/9},from:function(t){return 9*t/5-459.67}}},s={"m/s":{to:function(t){return t},from:function(t){return t}},"km/h":{to:function(t){return t/3.6},from:function(t){return 3.6*t}},mph:{to:function(t){return t/2.236936},from:function(t){return 2.236936*t}}},c={Pa:{to:function(t){return t},from:function(t){return t}},bar:{to:function(t){return 1e5*t},from:function(t){return t/1e5}},mbar:{to:function(t){return 100*t},from:function(t){return t/100}},hPa:{to:function(t){return 100*t},from:function(t){return t/100}},mmHg:{to:function(t){return 133.322387415*t},from:function(t){return t/133.322387415}},inHg:{to:function(t){return 3386.39*t},from:function(t){return t/3386.39}}},u=Object.assign({},r,l,s,c);if(!(u.hasOwnProperty(e)&&u.hasOwnProperty(n)))return t;if(r.hasOwnProperty(e)&&r.hasOwnProperty(n))return a(r[n].from(r[e].to(t)),o);if(l.hasOwnProperty(e)&&l.hasOwnProperty(n))return a(l[n].from(l[e].to(t)),o);if(s.hasOwnProperty(e)&&s.hasOwnProperty(n))return a(s[n].from(s[e].to(t)),o);if(c.hasOwnProperty(e)&&c.hasOwnProperty(n))return a(c[n].from(c[e].to(t)),o);else return t}function setElement(t,e,n=""){var o=document.getElementById(t);o&&(e?o.innerHTML=e:o.innerHTML=n)}function setProgress(t,e){var n=document.getElementById(t);if(n){var o=n.parentNode.clientWidth,a=n.parentNode.clientHeight,r=o/100*Number(e);r>o&&(r=o),n.style.width=r.toString()+"px",n.style.height=a+"px"}}function setPlayerIcon(t,e){var n=document.getElementById(t);n&&(n.className="fa fa-"+e)}function setLighting(t){if(!t)var t=new Date;var e=getLighting(t),n=SunCalc.getTimes(t,latitude,longitude),o=SunCalc.getMoonTimes(t,latitude,longitude),a=SunCalc.getMoonIllumination(t),r=a.age,l=Math.round(100*a.fraction),s=document.getElementById("lighting/moonage");s&&(s.innerHTML="",s.className="wi wi-moon-"+r.toString()),setElement("lighting/moonpercent",l,"0"),console.log("Current lighting condition: "+e.fullName),setElement("lighting/fullname",e.fullName),setElement("lighting/sunrise",date2HHmm(n.sunrise)),setElement("lighting/noon",date2HHmm(n.solarNoon)),setElement("lighting/sunset",date2HHmm(n.sunset)),o.set?setElement("lighting/moonset",date2HHmm(o.set)):setElement("lighting/moonset","—"),o.rise?setElement("lighting/moonrise",date2HHmm(o.rise)):setElement("lighting/moonrise","—"),o.alwaysDown&&(setElement("lighting/moonset",i18n.__("always")),setElement("lighting/moonrise","—")),o.alwaysUp&&(setElement("lighting/moonset","—"),setElement("lighting/moonrise",i18n.__("always"))),setElement("lighting/blueHourDawn/begin",date2HHmm(n.blueHourDawn)),setElement("lighting/blueHourDawn/end",date2HHmm(n.blueHourDawnEnd)),setElement("lighting/blueHourDusk/begin",date2HHmm(n.blueHourDusk)),setElement("lighting/blueHourDusk/end",date2HHmm(n.blueHourDuskEnd)),setElement("lighting/goldenHourDawn/begin",date2HHmm(n.sunriseEnd)),setElement("lighting/goldenHourDawn/end",date2HHmm(n.goldenHourEnd)),setElement("lighting/goldenHourDusk/begin",date2HHmm(n.goldenHour)),setElement("lighting/goldenHourDusk/end",date2HHmm(n.sunsetStart)),document.documentElement.style.backgroundColor=e.backgroundColor,document.documentElement.style.color=e.textColor,document.documentElement.style.backgroundImage="url('images/"+e.shortName+".jpg')"}function shorten(t,e=weatherTopic){return t.replace(e,"")}function shortest(t){return t.split("/").pop()}function onConnect(){console.log("Connected to broker "+host+":"+port+" as user '"+username+"'"),console.log("Subscribing to weather status at "+weatherTopic+"#"),mqtt.subscribe(weatherTopic+"#"),console.log("Subscribing to radio status at "+radioTopic+"#"),mqtt.subscribe(radioTopic+"#"),console.log("Subscribing to studio status at "+indicatorTopic+"#"),mqtt.subscribe(indicatorTopic+"#"),console.log("Subscribing to Kodi status at "+kodiTopic+"#"),mqtt.subscribe(kodiTopic+"#"),console.log("Subscribing to device command at "+commandTopic+"#"),mqtt.subscribe(commandTopic+"#")}function onFailure(t){console.log("Connection to "+host+":"+port+" as user '"+username+"' failed"),setTimeout(MQTTconnect,reconnectTimeout)}function onMessageArrived(t){out_msg=t.destinationName+": "+t.payloadString,console.log(out_msg);var e=shorten(t.destinationName),n=shortest(t.destinationName);if("latitude"==e&&(latitude=Number(t.payloadString)),"longitude"==e&&(longitude=Number(t.payloadString)),"local_tz_long"==e&&(timezoneLong=t.payloadString),t.destinationName.startsWith(commandTopic)&&(["reload"].includes(e=shorten(t.destinationName,commandTopic))?(console.log("RELOADING ..."),window.location.reload(!0)):console.log("Ignoring unknown command "+e)),t.destinationName.startsWith(kodiTopic)){if(["title","playbackstate","progress"].includes(e=shorten(t.destinationName,kodiTopic))){var o=JSON.parse(t.payloadString);switch(e){case"title":if(kodiPlaybackState>0){setElement("kodi/title",o.val,"\xa0");var a=o.kodi_details.type.charAt(0).toUpperCase()+o.kodi_details.type.slice(1);setElement("kodi/title/type",i18n.__(a)),setElement("kodi/title/label",o.kodi_details.label)}break;case"playbackstate":(kodiPlaybackState=o.val)<=0&&(setPlayerIcon("kodi/state","stop"),setElement("kodi/title",""),setElement("kodi/title/type",""),setElement("kodi/title/label",""),setProgress("kodi/progress","0")),1==kodiPlaybackState?setPlayerIcon("kodi/state","play"):2==kodiPlaybackState&&setPlayerIcon("kodi/state","pause");break;case"progress":kodiPlaybackState>0&&setProgress("kodi/progress",o.val)}}return}if(t.destinationName.startsWith(radioTopic)){["title"].includes(e=shorten(t.destinationName,radioTopic))?setElement("radio/status/"+e,t.payloadString,"\xa0"):setElement("radio/status/"+e,t.payloadString);return}if(t.destinationName.startsWith(indicatorTopic)){var r=shorten(t.destinationName,indicatorTopic),l=document.getElementById("studio/status/"+r);if(l){if(["white","green","yellow","red","blue","switch"].includes(r))switch(t.payloadString){case"on":console.log(r+": "+t.payloadString),l.classList.contains("flash")&&l.classList.remove("flash"),l.classList.contains("blink")&&l.classList.remove("blink"),l.classList.contains("on")||l.classList.add("on");break;case"off":console.log(r+": "+t.payloadString),l.classList.contains("flash")&&l.classList.remove("flash"),l.classList.contains("blink")&&l.classList.remove("blink"),l.classList.contains("on")&&l.classList.remove("on");break;case"flash":console.log(r+": "+t.payloadString),l.classList.contains("on")&&l.classList.remove("on"),l.classList.contains("blink")&&l.classList.remove("blink"),l.classList.contains("flash")||l.classList.add("flash");break;case"blink":console.log(r+": "+t.payloadString),l.classList.contains("on")&&l.classList.remove("on"),l.classList.contains("flash")&&l.classList.remove("flash"),l.classList.contains("blink")||l.classList.add("blink")}else l.innerHTML=t.payloadString;return}}var l=document.getElementById(e);if(l){if(l.innerHTML=t.payloadString,"winddirection"==n&&(l.innerHTML="",l.className="wi wi-wind from-"+t.payloadString+"-deg"),"icon"==n&&(l.innerHTML="",l.className="wi "+t.payloadString),["temperature","feelslike"].includes(e)&&(l.innerHTML=unitConvert(Number(t.payloadString),"C",i18n.__(".temperature"),1).toLocaleString(locale)),["pressure"].includes(e)&&(l.innerHTML=unitConvert(Number(t.payloadString),"hPa",i18n.__(".pressure"),Number(i18n.__(".pressure_decimals"))).toLocaleString(locale)),["elevation"].includes(e)&&(l.innerHTML=unitConvert(Number(t.payloadString),"m",i18n.__(".elevation")).toLocaleString(locale)),["temperature_low","temperature_high"].includes(n)&&(l.innerHTML=unitConvert(Number(t.payloadString),"C",i18n.__(".temperature")).toLocaleString(locale)),["windspeed","windspeed_max"].includes(n)&&(l.innerHTML=unitConvert(Number(t.payloadString),"km/h",i18n.__(".speed"),Number(i18n.__(".speed_decimals"))).toLocaleString(locale)),["precipitation"].includes(n)&&(numberCheck(t.payloadString)?l.innerHTML=unitConvert(Number(t.payloadString),"mm",i18n.__(".precipitation"),Number(i18n.__(".precipitation_decimals"))).toLocaleString(locale):l.innerHTML="–"),["snow"].includes(n)&&(numberCheck(t.payloadString)?l.innerHTML=unitConvert(Number(t.payloadString),"cm",i18n.__(".snowfall"),Number(i18n.__(".snowfall_decimals"))).toLocaleString(locale):l.innerHTML="–"),["humidity","pop","uv"].includes(n)&&(l.innerHTML=Number(t.payloadString).toLocaleString(locale),"uv"==n)){var s=Number(t.payloadString);switch(!0){case s>=11:l.className="uv-color uv-color-purple",l.title=i18n.__("Risk: Extreme");break;case s>=8:l.className="uv-color uv-color-red",l.title=i18n.__("Risk: Very high");break;case s>=6:l.className="uv-color uv-color-orange",l.title=i18n.__("Risk: High");break;case s>=3:l.className="uv-color uv-color-yellow",l.title=i18n.__("Risk: Moderate");break;case s>=0:l.className="uv-color uv-color-green",l.title=i18n.__("Risk: Low");break;default:l.className="uv-color uv-color-none",l.title=""}}if(["wind_dir","weather"].includes(n)&&(l.innerHTML=i18n.__(t.payloadString)),"observation_epoch"==e){var c=new Date(1e3*Number(t.payloadString)),u={weekday:"short",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",timeZoneName:"short",timeZone:timezoneLong};l.innerHTML=c.toLocaleString(locale,u)}if(["sunrise","sunset","moonrise","moonset"].includes(e)&&(l.innerHTML=HHmm2HHmm(t.payloadString)),"epoch"==n){var c=new Date(1e3*Number(t.payloadString)),u={weekday:"long",timeZone:timezoneLong};l.innerHTML=c.toLocaleString(locale,u)}}}function onConnectionLost(t){console.log("Lost connection to "+t.uri+" ("+t.errorCode.toString()+")"),t.reconnect?console.log("Automatic reconnect is active."):console.log("No automatic reconnect will be attempted.")}function MQTTconnect(){console.log("Connecting to "+host+":"+port);var t={userName:username,password:password,timeout:3,reconnect:reconnect,onSuccess:onConnect,onFailure:onFailure};(mqtt=new Paho.MQTT.Client(host,port,clientId)).onConnectionLost=onConnectionLost,mqtt.onMessageArrived=onMessageArrived,mqtt.connect(t)}if(location.hostname)var configfile="config/"+location.hostname+".cfg";else var configfile="config/unknown_host.cfg";function init1(t){console.log("Init stage 1: Configuration"),config.parse(t),reconnectTimeout=config.getNumber(mySection,"reconnect_timeout"),reconnect=config.getBoolean(mySection,"reconnect"),host=config.get(mqttSection,"host"),port=config.getNumber(mqttSection,"websockets_port"),clientId=config.get(mySection,"client_id"),username=config.get(mqttSection,"username"),password=config.get(mqttSection,"password"),weatherTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"weather_topic"),indicatorTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"indicator_topic"),radioTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"radio_topic"),kodiTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"kodi_topic"),commandTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"client_topic")+"command/",latitude=config.getNumber(mySection,"latitude"),longitude=config.getNumber(mySection,"longitude"),timezoneLong=config.get(mySection,"timezone"),locale=config.get(mySection,"locale"),document.title=config.get(mySection,"title"),setElement("title",config.get(mySection,"title")),fetch("config/lang-"+locale+".json",{cache:"reload",mode:"no-cors"}).then(t=>t.json()).then(t=>init2(t))}function init2(t){console.log("Init stage 2: Localization"),(i18n=window.i18n()).loadJSON(t,"messages"),i18n.setLocale(locale);var e=[".temperature",".speed",".pressure",".precipitation",".snowfall",".elevation"];for(i=0;i<e.length;i++){var n=document.getElementsByClassName(e[i]);for(j=0;j<n.length;j++)n[j].innerHTML=i18n.__(e[i]+"_text")}var n=document.getElementsByClassName("i18n");for(i=0;i<n.length;i++)n[i].innerHTML=i18n.__(n[i].innerHTML);updateLighting=setInterval(function(){setLighting()},6e4),MQTTconnect(),setLighting()}console.log("Read configuration from "+configfile),fetch(configfile,{cache:"reload",mode:"no-cors"}).then(t=>t.text()).then(t=>init1(t));
